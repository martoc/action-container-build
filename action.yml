---
name: "Build a container with Docker"
description: |
  This action builds a container with Docker and pushes it to a registry.
author: martoc
runs:
  using: "composite"
  steps:
    - name: Container Build
      shell: bash
      run: |
        DOCKERFILE="Dockerfile"
        NAME="${{ github.repository }}"
        NAME="${NAME#*/}"
        NAME="${NAME#docker-}"
        NAMESPACE="${{ github.repository_owner }}"
        DESCRIPTION="${{ github.event.head_commit.message }}"
        BUILD_ARGS=""
        label_args=(
          --label "org.label-schema.name=${NAME}"
          --label "org.label-schema.schema-version=1.0"
          --label "org.label-schema.vcs-url=${GITHUB_SERVER_URL}/${GITHUB_REPOSITORY}"
          --label "org.label-schema.vcs-ref=${GITHUB_SHA}"
          --label "org.label-schema.build-date=$(date -u +'%Y-%m-%dT%H:%M:%SZ')"
          --label "org.label-schema.version=${TAG_VERSION}"
          --label "org.label-schema.description=$DESCRIPTION"
          --label "org.label-schema.usage=${GITHUB_SERVER_URL}/${GITHUB_REPOSITORY}/tree/${TAG_NAME}/docs/index.md"
          --label "org.label-schema.url=${GITHUB_SERVER_URL}/${GITHUB_REPOSITORY}"
          --label "org.opencontainers.image.ref.name=${NAME}"
          --label "org.opencontainers.image.source=${GITHUB_SERVER_URL}/${GITHUB_REPOSITORY}"
          --label "org.opencontainers.image.revision=${GITHUB_SHA}"
          --label "org.opencontainers.image.created=$(date -u +'%Y-%m-%dT%H:%M:%SZ')"
          --label "org.opencontainers.image.version=${TAG_VERSION}"
          --label "org.opencontainers.image.url=${GITHUB_SERVER_URL}/${GITHUB_REPOSITORY}"
          --label "org.opencontainers.image.title=${NAME}"
          --label "org.opencontainers.image.documentation=${GITHUB_SERVER_URL}/${GITHUB_REPOSITORY}/tree/${TAG_NAME}/docs/index.md"
          --label "org.opencontainers.image.description=${DESCRIPTION}"
          --label "org.opencontainers.image.authors=${GITHUB_ACTOR}"
          --label "org.opencontainers.image.licenses=â€œCopyright (c) $(date -u +'%Y') martoc"
        )
        docker build "${label_args[@]}" \
          --build-arg TAG_VERSION=${TAG_VERSION} \
          --build-arg BUILD_SHA=${BUILD_SHA} \
          --build-arg OS=linux \
          --build-arg arch=amd64 \
          ${BUILD_ARGS} \
          --tag ${NAMESPACE}/${NAME}:latest \
          --tag ${NAMESPACE}/${NAME}:${TAG_VERSION} .
        docker login -u ${{ secrets.DOCKER_USERNAME }} -p ${{ secrets.DOCKER_PASSWORD }}
        docker push \
          ${NAMESPACE}/${NAME}:${TAG_VERSION} \
          ${NAMESPACE}/${NAME}:latest
